"use strict";var Furple;(function(s){function E(h){return s.flatten(h.map(w=>s.liftAll(w,(...d)=>d)))}s.flattenArray=E;function l(h,w){return E(h.map(d=>d.map(w)))}s.mapArray=l;function O(h,w){return s.flatten(h.map(d=>s.select(...d.map(w))))}s.selectArray=O;function g(h,w,d){return s.flatten(h.map(f=>s.liftAll(f,(...o)=>o.reduce(d,w))))}s.foldArray=g;function _(h,w,d){const f=s.constant(w);return s.flatten(h.map(o=>m(o,f,d,0,o.length)))}s.foldAssociative=_;function m(h,w,d,f,o){if(f===o)return w;if(f+1===o)return h[f];{const N=f+o>>>1,u=m(h,w,d,f,N),b=m(h,w,d,N,o);return u.lift(b,d)}}})(Furple||(Furple={}));var Furple;(function(s){const E={kind:0,engine:void 0},l=Symbol();function O(i,e){const n=i.parents;if(n!==void 0)for(let t=n.length-1;t>=0;--t){const r=n[t].deref();if(r!==void 0){if(e(r)===l)return l}else n[t]=n[n.length-1],n.pop()}}function g(i,e){const n=i.parents;for(let t=0;t<n.length;){const r=n[t].deref();if(r!==void 0){if(e(r)===l)return l;++t}else n.splice(t,1)}}function _(i,e){switch(i.kind){case 0:case 19:case 20:return;case 1:return O(i,e);case 2:case 3:case 17:case 18:case 6:case 4:case 5:case 13:case 14:case 15:case 16:{const t=i.parent.deref();return t!==void 0?e(t):void 0}case 7:return e(i.parent1)===l?l:e(i.parent2);case 8:{for(const t of i.parents)if(e(t)===l)return l;return}case 12:return g(i,e);case 11:{for(const t of i.parents){const r=t.deref();if(r!==void 0&&e(r)===l)return l}return}case 9:case 10:case 21:{const t=i.parent1.deref(),r=i.parent2?.deref();return t!==void 0&&e(t)===l?l:r!==void 0?e(r):void 0}}const n=i}function m(i,e){switch(i.kind){case 19:case 20:{const n=i.parent.deref();n!==void 0&&e(n);return}case 15:{e(i.cell);return}case 16:{for(const n of i.cells)if(e(n)===l)return;return}}}function h(i,e){_(i,e)!==l&&m(i,e)}function w(i,e){for(const n of i.notifiableChildren)e(n)}function d(i,e){w(i,e);for(const n of i.nonNotifiableChildren)e(n);if(i.rule.kind===17||i.rule.kind===18)for(const n of i.rule.f.values())e(n)}s.DO_NOT_SEND=Symbol();const f=Symbol(),o=Symbol(),N=Object.is;class u{rule;value;name=void 0;depth=0;newValue=f;equalityFunc=N;notifiableChildren=[];nonNotifiableChildren=[];constructor(e,n){this.rule=e,this.value=n,_(e,t=>{t.addNotifiableChild(this)}),this.#n()}named(e){return this.name=e,this}#n(){const e=this.depth;let n=0;return h(this.rule,t=>{t.depth>=n&&(n=t.depth+1)}),this.depth=n,n>e}recomputeDepth(){if(!this.#n())return!1;const e=[this];for(;e.length>0;){const n=e.pop();d(n,t=>{t===this&&z(this),t.#n()&&e.push(t)})}return!0}addNotifiableChild(e){this.notifiableChildren.push(e)}addNonNotifiableDependent(e){this.nonNotifiableChildren.push(e)}removeNotifiableChild(e){const n=this.notifiableChildren,t=n.indexOf(e);t>=0&&n.splice(t,1)}removeNonNotifiableChild(e){if(e.rule.kind===19||e.rule.kind===20)this.rule.f.delete(e.rule.key);else{const n=this.nonNotifiableChildren,t=n.indexOf(e);t>=0&&n.splice(t,1)}}isClosed(){return this.rule.kind===0}close(){if(this.rule.engine?.isBusy())throw new Error("close() cannot be called during an FRP transaction");return p(this),this}tidy(){const e=this.rule;let n=!0;if(_(e,t=>{if(!t.isClosed())return n=!1,l}),n){p(this);return}switch(e.kind){case 9:{const t=e.parent1.deref(),r=e.parent2.deref();t===void 0||t.isClosed()?this.rule={kind:3,engine:e.engine,parent:e.parent2}:(r===void 0||r.isClosed())&&(this.rule={kind:3,engine:e.engine,parent:e.parent1});break}case 10:{const t=e.parent1.deref(),r=e.parent2.deref();(t===void 0||r===void 0||t.isClosed()||r.isClosed())&&p(this);break}case 11:{for(const t of e.parents){const r=t.deref();if(r===void 0||r.isClosed()){p(this);break}}break}case 12:{e.parents.length===1&&(this.rule={kind:3,engine:e.engine,parent:e.parents[0]});break}}}listen(e){const n=this.rule.engine;return n!==void 0?new u({kind:2,engine:n,parent:new WeakRef(this),f:e},o):this}observe(e){return e(this.value),this.listen(e)}send(e){k(this).send(this,e)}sendAnd(e,n){const t=k(this);t.run(()=>{t.send(this,e),n()})}connect(e){return I(this,e),this}sample(){const e=this.rule.engine;return e!==void 0?e.sample(this):this.value}setEqualityFunction(e){if(d(this,()=>{throw new Error("Equality function should only be set when the cell is originally created")}),this.equalityFunc!==N)throw new Error("This cell already has an equality function");return this.equalityFunc=e,this}map(e){return v(this,e)}lift(e,n){const t=this,r=e,a=t.rule.engine??r.rule.engine,c=n(t.value,r.value);return a===void 0?D(c):new u({kind:7,engine:a,parent1:t,parent2:r,f:n},c)}hold(e){const n=this.rule.engine;return n===void 0?D(e):new u({kind:3,engine:n,parent:new WeakRef(this)},e)}fold(e,n){return y(this,e,n)}foldS(e,n){return B(this,e,n)[1]}foldBoth(e,n){return B(this,e,n)}filter(e){const n=this.rule.engine,t=this;return n!==void 0?new u({kind:5,engine:n,parent:new WeakRef(t),f:e},o):s.NEVER}gate(e){return e.isClosed()?e.sample()?this:s.NEVER:this.filter(()=>e.sample())}gateLive(e){return e.isClosed()?e.sample()?this:s.NEVER:this.snapLive(e,(t,r)=>r?t:s.DO_NOT_SEND)}merge(e,n){const t=this,r=e;if(t.isClosed())return e;if(r.isClosed())return t;const a=k(t);return new u({kind:9,engine:a,parent1:new WeakRef(t),parent2:new WeakRef(r),f:n},o)}orElse(e){return G(this,e)}mergeMutex(e){return this.merge(e,()=>{throw new Error("Mutually exclusive streams fired simultaneously")})}meet(e,n){const t=this,r=e;if(t.isClosed()||r.isClosed())return s.NEVER;const a=k(t);return new u({kind:10,engine:a,parent1:new WeakRef(t),parent2:new WeakRef(r),f:n},o)}snapshot(e,n){return V(this,e,!1,n)}snapLive(e,n){return V(this,e,!0,n)}as(e){return V(this,e,!1,(n,t)=>t)}asLive(e){return V(this,e,!0,(n,t)=>t)}asConstant(e){return v(this,()=>e)}snapshotAll(e,n){return R(this,e,!1,n)}snapAllLive(e,n){return R(this,e,!0,n)}when(e){const n=this.rule;switch(n.kind){case 0:return this.value!==o?D(this.value===e):s.NEVER;case 17:{const t=this;let r=n.f.get(e);return r===void 0&&(r=new u({kind:19,engine:n.engine,parent:new WeakRef(t),key:e},this.value===e),n.f.set(e,r)),r}case 18:{const t=this;let r=n.f.get(e);return r===void 0&&(r=new u({kind:20,engine:n.engine,parent:new WeakRef(t),key:e},o),n.f.set(e,r)),r}}throw new S("Cannot branch on non-BRANCH node",this)}}const b=[u,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,BigUint64Array,Int8Array,Int16Array,Int32Array,BigInt64Array,Float32Array,Float64Array];function Q(i){return b.some(e=>i instanceof e)?i:Object.freeze(i)}class T{#n=[];#t=0;#e=0;enqueue(e){const n=this.#n,t=e.depth;for(;n.length<=t;)n.push([]);n[t].push(e),++this.#t}poll(){const e=this.#n;let n=this.#e;for(;n<e.length;){if(e[n].length>0)return--this.#t,e[n].pop();++this.#e,++n}}rebuild(){const e=this.#n.flat();this.reset();for(const n of e)this.enqueue(n)}reset(){for(const e of this.#n)e.length=0;this.#t=0,this.#e=0}}function W(){return new A}s.engine=W;class A{#n=[];#t=new T;#e=0;#s={kind:1,engine:this,parents:void 0,f:void 0};#r(e,n){if(e.value!==o&&e.equalityFunc(e.value,n))return;const t=e.rule;if(t.kind===1&&e.newValue!==f){const r=t.f;if(r===void 0)throw new S("This sink cannot coalesce simultaneous events",e);e.newValue=r(e.newValue,n);return}e.newValue=n,this.#n.push(e),w(e,r=>this.#t.enqueue(r))}#i(e){const n=e.rule;switch(n.kind){case 0:case 19:case 20:throw new S("This node should not be recomputed",e);case 1:{if(n.parents===void 0)return e.newValue;const t=n.f;let r=f;return O(n,a=>{r===f?r=a.newValue:a.newValue!==f&&(r=t(r,a.newValue))}),r!==f?r:s.DO_NOT_SEND}case 2:case 3:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):t.newValue}case 4:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(t.newValue)}case 5:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const r=t.newValue;return n.f(r)?r:s.DO_NOT_SEND}case 6:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(e.value,t.newValue)}case 7:return n.f(U(n.parent1),U(n.parent2));case 8:{const t=n.parents.map(U);return n.f(...t)}case 9:{const t=n.parent1.deref(),r=n.parent2.deref();return t===void 0?r===void 0?(p(e),s.DO_NOT_SEND):(e.rule={kind:3,engine:n.engine,parent:n.parent2},this.#i(e)):r===void 0?(e.rule={kind:3,engine:n.engine,parent:n.parent1},this.#i(e)):r.newValue===f?t.newValue:t.newValue===f?r.newValue:n.f(t.newValue,r.newValue)}case 10:{const t=n.parent1.deref(),r=n.parent2.deref();return t===void 0||r===void 0||t.isClosed()||r.isClosed()?(p(e),s.DO_NOT_SEND):t.newValue!==f&&r.newValue!==f?n.f(t.newValue,r.newValue):s.DO_NOT_SEND}case 11:{const t=[];for(const r of n.parents){const a=r.deref();if(a===void 0||a.isClosed())return p(e),s.DO_NOT_SEND;if(a.newValue===f)return s.DO_NOT_SEND;t.push(a.newValue)}return n.f(...t)}case 12:{let t=s.DO_NOT_SEND;return g(n,r=>{if(r.newValue!==f)return t=r.newValue,l}),t}case 13:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(t.newValue,n.cell.value)}case 14:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const r=n.cells.map(a=>a.value);return n.f(t.newValue,...r)}case 15:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(t.newValue,U(n.cell))}case 16:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const r=n.cells.map(U);return n.f(t.newValue,...r)}case 17:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const r=t.newValue,a=n.f.get(t.value),c=n.f.get(r);return a!==void 0&&this.#r(a,!1),c!==void 0&&this.#r(c,!0),r}case 18:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const r=t.newValue,a=n.f.get(r);return a!==void 0&&this.#r(a,r),r}case 21:{const t=n.parent1.deref();if(t===void 0)return e.rule=n.parent2!==void 0?{kind:3,engine:n.engine,parent:n.parent2}:{kind:0,engine:void 0},this.#i(e);const r=n.parent2?.deref(),a=U(t);return r!==a&&(r?.removeNotifiableChild(e),a?.addNotifiableChild(e),n.parent2=a!==void 0?new WeakRef(a):void 0,e.recomputeDepth()&&this.#t.rebuild()),a===void 0?void 0:a.newValue!==f?a.newValue:a.value!==o?a.value:s.DO_NOT_SEND}}}send(e,n){const t=e;if(t.isClosed())throw new Error("Cannot send to this sink; it is closed");switch(this.#e){case 0:{this.run(()=>this.#r(t,n));break}case 1:{this.#r(t,n);break}default:throw new Error("send() cannot be called during an FRP transaction")}}run(e){if(this.#e!==0)throw new Error("run() cannot be called during an FRP transaction");try{this.#e=1,e(),this.#e=2;const n=this.#t,t=new Set;for(;;){const r=n.poll();if(r===void 0)break;if(t.has(r))continue;t.add(r),$(r)&&(this.#e=3);const a=this.#i(r);this.#e=2,a!==s.DO_NOT_SEND&&this.#r(r,a)}for(const r of this.#n)r.value!==o&&(r.value=r.newValue);this.#e=4;for(const r of this.#n)r.rule.kind===2&&r.rule.f(r.newValue);this.#e=5}finally{this.#t.reset();for(const n of this.#n)n.newValue=f;this.#n.length=0,this.#e=0}}isBusy(){return this.#e===2||this.#e===3}sample(e){return this.#e===2&&console.error("sample() should not be called here"),e.value}cell(e){return new u(this.#s,e)}sink(e){return new u(e!==void 0?{kind:1,engine:this,parents:[],f:e}:this.#s,o)}}s.Engine=A;function I(i,e){const n=i.rule.engine;if(n===void 0)throw new Error("Cannot connect; sink is already closed");if(n.isBusy())throw new Error("Cannot connect during an FRP transaction");if(i.rule.kind!==1)throw new Error("Cannot connect; sink is already connected");e.value!==o&&n.send(i,e.value);const t=i.rule,r=new WeakRef(e);t.parents===void 0?i.rule={kind:3,engine:n,parent:r}:t.parents.push(r),e.addNotifiableChild(i),i.recomputeDepth()}function v(i,e){const n=i.rule.engine;return n===void 0&&i.value===o?s.NEVER:new u(n===void 0?E:{kind:4,engine:n,parent:new WeakRef(i),f:e},i.value!==o?e(i.value):o)}function y(i,e,n){const t=i,r=t.rule.engine;return new u(r===void 0?E:{kind:6,engine:r,parent:new WeakRef(t),f:n},e)}function B(i,e,n){const t=i,r=t.rule.engine;if(r===void 0)return[D(e),s.NEVER];const a=y(i,e,n),c=new u({kind:3,engine:r,parent:new WeakRef(a)},o);return[a,c]}function V(i,e,n,t){const r=i,a=e,c=r.rule.engine;if(c===void 0)return s.NEVER;const C=n?15:13;return new u({kind:C,engine:c,parent:new WeakRef(r),cell:a,f:t},o)}function R(i,e,n,t){if(e.length===0)return i.map(t);if(e.length===1)return V(i,e[0],n,t);const r=i,a=e,c=r.rule.engine;if(c===void 0)return s.NEVER;const C=n?16:14;return new u({kind:C,engine:c,parent:new WeakRef(r),cells:a,f:t},o)}s.NEVER=new u(E,o);function D(i){return new u(E,i)}s.constant=D,s.UNDEFINED=D(void 0);function P(i){return i instanceof u&&i.value!==o}s.isCell=P;function q(i){return i instanceof u&&i.value===o}s.isStream=q;function j(i,e){const n=i;let t;for(const c of n)if(t=c.rule.engine,t!==void 0)break;if(n.length===0)return D(e());if(n.length===1)return n[0].map(e);if(n.length===2)return n[0].lift(n[1],e);const r=n.map(c=>c.value),a=e(...r);return t===void 0?D(a):new u({kind:8,engine:t,parents:n,f:e},a)}s.liftAll=j;function x(i,e){const n=[];for(const r of i){const a=r;if(a.isClosed())return s.NEVER;n.push(new WeakRef(a))}const t=k(i[0]);return new u({kind:11,engine:t,parents:n,f:e},o)}s.meetAll=x;function G(...i){const e=i.filter(t=>!t.isClosed());if(e.length===0)return s.NEVER;if(e.length===1)return e[0];const n=k(e[0]);return new u({kind:12,engine:n,parents:e.map(t=>new WeakRef(t))},o)}s.select=G;function L(i){const e=i,n=e.rule.engine;if(n===void 0)return e;const t=e.value!==o?17:18;return new u({kind:t,engine:n,parent:new WeakRef(e),f:new Map},e.value)}s.branch=L;function J(i){const e=i,n=e.value,t=e.rule.engine;if(t===void 0)return n??s.UNDEFINED;const r={kind:21,engine:t,parent1:new WeakRef(e),parent2:n!==void 0?new WeakRef(n):void 0};return new u(r,n?.value)}s.flatten=J;function M(i,e,n=s.Type.STR){const t=r=>{try{window.localStorage.setItem(i,n.toStr(r))}catch(a){console.error(`Failed to store '${i}' in local storage`,a)}};try{const r=e,a=window.localStorage.getItem(i);a!==null?(r.send(n.fromStr(a)),r.listen(t)):r.observe(t)}catch{console.warn(`Failed to load '${i}' from local storage`)}}s.persist=M;function k(i){const e=i.rule.engine;if(e===void 0)throw new S("Node is closed",i);return e}function U(i){return i.newValue!==f?i.newValue:i.value}function $(i){switch(i.rule.kind){case 4:return i.value===o;case 5:case 6:case 9:case 13:case 14:return!0;default:return!1}}function p(i){if(i.isClosed())return;const e=i.rule;i.rule=E,i.depth=0,_(e,n=>n.removeNotifiableChild(i)),m(e,n=>n.removeNonNotifiableChild(i)),d(i,n=>n.tidy()),i.notifiableChildren.length=0,i.nonNotifiableChildren.length=0}function K(i){if(i.value===o)throw new S("Expected cell",i)}function Y(i,...e){for(const n of e)if(n.rule.engine!==void 0&&n.rule.engine!==i)throw new S("Object is owned by a different FRP engine",[i,n])}function Z(...i){if(i.every(e=>e.newValue===f))throw new S("At least one of these nodes should have been updated",i)}function z(i){const e=new Map,n=[i];for(;;){const t=n.shift();if(t===void 0)throw new S("Expected to report cycle, but no cycle was found!",i);h(t.rule,r=>{if(r===i){const a=[];let c=t;for(;c!==void 0;)a.push(c),c=e.get(c);a.reverse();const C=`Circular dependency:
---
`+a.map(H=>H.name??"<anonymous>").join(`
`);throw console.error(C,a),new Error(`${C}
---
See console for more details`)}else e.has(r)||(n.push(r),e.set(r,t))})}}class S extends Error{data;constructor(e,n){super(e),this.data=n}}})(Furple||(Furple={}));var Furple;(function(s){let E;(function(l){const O=f=>f,g=f=>`${f}`;l.BOOL={toStr:f=>f?"true":"false",fromStr:f=>f==="true"},l.INT={toStr:g,fromStr:f=>parseInt(f)},l.BIGINT={toStr:g,fromStr:BigInt},l.FLOAT={toStr:g,fromStr:parseFloat},l.STR={toStr:O,fromStr:O};function _(f){return{toStr:o=>JSON.stringify(o.map(f.toStr)),fromStr:o=>JSON.parse(o).map(f.fromStr)}}l.array=_;function m(f){return{toStr:o=>JSON.stringify(d(o,f.toStr)),fromStr:o=>d(JSON.parse(o),f.fromStr)}}l.object=m;function h(f){return{toStr:o=>JSON.stringify(d(Object.fromEntries(o),f.toStr)),fromStr:o=>new Map(Object.entries(d(JSON.parse(o),f.fromStr)))}}l.map=h;function w(f){return{toStr:o=>JSON.stringify([...o].map(f.toStr)),fromStr:o=>new Set(JSON.parse(o).map(f.fromStr))}}l.set=w;function d(f,o){const N=Object.create(null);for(const[u,b]of Object.entries(f))N[u]=o(b);return N}})(E=s.Type||(s.Type={}))})(Furple||(Furple={}));
