"use strict";var Furple;(function(s){function g(h){return s.flatten(h.map(w=>s.liftAll(w,(...d)=>d)))}s.flattenArray=g;function f(h,w){return g(h.map(d=>d.map(w)))}s.mapArray=f;function O(h,w){return s.flatten(h.map(d=>s.select(...d.map(w))))}s.selectArray=O;function m(h,w,d){return s.flatten(h.map(u=>s.liftAll(u,(...a)=>a.reduce(d,w))))}s.foldArray=m;function _(h,w,d){const u=s.constant(w);return s.flatten(h.map(a=>N(a,u,d,0,a.length)))}s.foldAssociative=_;function N(h,w,d,u,a){if(u===a)return w;if(u+1===a)return h[u];{const E=u+a>>>1,l=N(h,w,d,u,E),v=N(h,w,d,E,a);return l.lift(v,d)}}})(Furple||(Furple={}));var Furple;(function(s){const g={kind:0,engine:void 0},f=Symbol();function O(r,e){const n=r.parents;if(n!==void 0)for(let t=n.length-1;t>=0;--t){const i=n[t].deref();if(i!==void 0){if(e(i)===f)return f}else n[t]=n[n.length-1],n.pop()}}function m(r,e){const n=r.parents;for(let t=0;t<n.length;){const i=n[t].deref();if(i!==void 0){if(e(i)===f)return f;++t}else n.splice(t,1)}}function _(r,e){switch(r.kind){case 0:case 16:return;case 1:return O(r,e);case 2:case 3:case 15:case 6:case 4:case 5:case 11:case 12:case 13:case 14:{const t=r.parent.deref();return t!==void 0?e(t):void 0}case 7:return e(r.parent1)===f?f:e(r.parent2);case 8:{for(const t of r.parents)if(e(t)===f)return f;return}case 10:return m(r,e);case 9:case 17:{const t=r.parent1.deref(),i=r.parent2?.deref();return t!==void 0&&e(t)===f?f:i!==void 0?e(i):void 0}}const n=r}function N(r,e){switch(r.kind){case 16:{const n=r.parent.deref();n!==void 0&&e(n);return}case 13:{e(r.cell);return}case 14:{for(const n of r.cells)if(e(n)===f)return;return}}}function h(r,e){_(r,e)!==f&&N(r,e)}function w(r,e){for(const n of r.notifiableChildren)e(n)}function d(r,e){w(r,e);for(const n of r.nonNotifiableChildren)e(n);if(r.rule.kind===15)for(const n of r.rule.f.values())e(n)}s.DO_NOT_SEND=Symbol();const u=Symbol(),a=Symbol(),E=Object.is;class l{rule;value;name=void 0;depth=0;newValue=u;equalityFunc=E;notifiableChildren=[];nonNotifiableChildren=[];constructor(e,n){this.rule=e,this.value=n,_(e,t=>{t.addNotifiableChild(this)}),this.#n()}named(e){return this.name=e,this}#n(){const e=this.depth;let n=0;return h(this.rule,t=>{t.depth>=n&&(n=t.depth+1)}),this.depth=n,n>e}recomputeDepth(){if(!this.#n())return!1;const e=[this];for(;e.length>0;){const n=e.pop();d(n,t=>{t===this&&M(this),t.#n()&&e.push(t)})}return!0}addNotifiableChild(e){this.notifiableChildren.push(e)}addNonNotifiableDependent(e){this.nonNotifiableChildren.push(e)}removeNotifiableChild(e){const n=this.notifiableChildren,t=n.indexOf(e);t>=0&&n.splice(t,1)}removeNonNotifiableChild(e){if(e.rule.kind===16)this.rule.f.delete(e.rule.key);else{const n=this.nonNotifiableChildren,t=n.indexOf(e);t>=0&&n.splice(t,1)}}isClosed(){return this.rule.kind===0}close(){if(this.rule.engine?.isBusy())throw new Error("close() cannot be called during an FRP transaction");return p(this),this}tidy(){const e=this.rule;let n=!0;if(_(e,t=>{if(!t.isClosed())return n=!1,f}),n)p(this);else if(e.kind===9){const t=e.parent1.deref(),i=e.parent2.deref();t===void 0||t.isClosed()?this.rule={kind:3,engine:e.engine,parent:e.parent2}:(i===void 0||i.isClosed())&&(this.rule={kind:3,engine:e.engine,parent:e.parent1})}else e.kind===10&&e.parents.length===1&&(this.rule={kind:3,engine:e.engine,parent:e.parents[0]})}listen(e){const n=this.rule.engine;return n!==void 0?new l({kind:2,engine:n,parent:new WeakRef(this),f:e},a):this}observe(e){return e(this.value),this.listen(e)}send(e){y(this).send(this,e)}sendAnd(e,n){const t=y(this);t.run(()=>{t.send(this,e),n()})}connect(e){return q(this,e),this}sample(){const e=this.rule.engine;return e!==void 0?e.sample(this):this.value}setEqualityFunction(e){if(d(this,()=>{throw new Error("Equality function should only be set when the cell is originally created")}),this.equalityFunc!==E)throw new Error("This cell already has an equality function");return this.equalityFunc=e,this}map(e){return V(this,e)}lift(e,n){const t=this,i=e,o=t.rule.engine??i.rule.engine,c=n(t.value,i.value);return o===void 0?S(c):new l({kind:7,engine:o,parent1:t,parent2:i,f:n},c)}hold(e){const n=this.rule.engine;return n===void 0?S(e):new l({kind:3,engine:n,parent:new WeakRef(this)},e)}fold(e,n){return R(this,e,n)}foldS(e,n){return T(this,e,n)[1]}foldBoth(e,n){return T(this,e,n)}filter(e){const n=this.rule.engine,t=this;return n!==void 0?new l({kind:5,engine:n,parent:new WeakRef(t),f:e},a):s.NEVER}gate(e){return this.filter(()=>e.sample())}merge(e,n){const t=this,i=e;if(t.isClosed())return e;if(i.isClosed())return t;const o=y(t);return new l({kind:9,engine:o,parent1:new WeakRef(t),parent2:new WeakRef(i),f:n},a)}orElse(e){return I(this,e)}mergeMutex(e){return this.merge(e,()=>{throw new Error("Mutually exclusive streams fired simultaneously")})}snapshot(e,n){return D(this,e,!1,n)}snapLive(e,n){return D(this,e,!0,n)}as(e){return D(this,e,!1,(n,t)=>t)}asLive(e){return D(this,e,!0,(n,t)=>t)}asConstant(e){return V(this,()=>e)}snapshotAll(e,n){return U(this,e,!1,n)}snapAllLive(e,n){return U(this,e,!0,n)}when(e){const n=this.rule,t=this.value===a?a:this.value===e;if(n.kind===15){let i=n.f.get(e);return i===void 0&&(i=new l({kind:16,engine:n.engine,parent:new WeakRef(this),key:e},t),n.f.set(e,i)),i}else return t!==a?S(t):s.NEVER}}const v=[l,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,BigUint64Array,Int8Array,Int16Array,Int32Array,BigInt64Array,Float32Array,Float64Array];function z(r){return v.some(e=>r instanceof e)?r:Object.freeze(r)}class W{#n=[];#t=0;#e=0;enqueue(e){const n=this.#n,t=e.depth;for(;n.length<=t;)n.push([]);n[t].push(e),++this.#t}poll(){const e=this.#n;let n=this.#e;for(;n<e.length;){if(e[n].length>0)return--this.#t,e[n].pop();++this.#e,++n}}rebuild(){const e=this.#n.flat();this.reset();for(const n of e)this.enqueue(n)}reset(){for(const e of this.#n)e.length=0;this.#t=0,this.#e=0}}function B(){return new C}s.engine=B;class C{#n=[];#t=new W;#e=0;#s={kind:1,engine:this,parents:void 0,f:void 0};#r(e,n){if(e.value!==a&&e.equalityFunc(e.value,n))return;const t=e.rule;if(t.kind===1&&e.newValue!==u){const i=t.f;if(i===void 0)throw new k("This sink cannot coalesce simultaneous events",e);e.newValue=i(e.newValue,n);return}e.newValue=n,this.#n.push(e),w(e,i=>this.#t.enqueue(i))}#i(e){const n=e.rule;switch(n.kind){case 0:case 16:throw new k("This node should not be recomputed",e);case 1:{if(n.parents===void 0)return e.newValue;const t=n.f;let i=u;return O(n,o=>{i===u?i=o.newValue:o.newValue!==u&&(i=t(i,o.newValue))}),i!==u?i:s.DO_NOT_SEND}case 2:case 3:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):t.newValue}case 4:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(t.newValue)}case 5:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const i=t.newValue;return n.f(i)?i:s.DO_NOT_SEND}case 6:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(e.value,t.newValue)}case 7:return n.f(b(n.parent1),b(n.parent2));case 8:{const t=n.parents.map(b);return n.f(...t)}case 9:{const t=n.parent1.deref(),i=n.parent2.deref();return t===void 0?i===void 0?(p(e),s.DO_NOT_SEND):(e.rule={kind:3,engine:n.engine,parent:n.parent2},this.#i(e)):i===void 0?(e.rule={kind:3,engine:n.engine,parent:n.parent1},this.#i(e)):i.newValue===u?t.newValue:t.newValue===u?i.newValue:n.f(t.newValue,i.newValue)}case 10:{let t=s.DO_NOT_SEND;return m(n,i=>{if(i.newValue!==u)return t=i.newValue,f}),t}case 11:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(t.newValue,n.cell.value)}case 12:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const i=n.cells.map(o=>o.value);return n.f(t.newValue,...i)}case 13:{const t=n.parent.deref();return t===void 0?(p(e),s.DO_NOT_SEND):n.f(t.newValue,b(n.cell))}case 14:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const i=n.cells.map(b);return n.f(t.newValue,...i)}case 15:{const t=n.parent.deref();if(t===void 0)return p(e),s.DO_NOT_SEND;const i=t.newValue;if(t.value!==a){const o=n.f.get(t.value),c=n.f.get(i);o!==void 0&&this.#r(o,!1),c!==void 0&&this.#r(c,!0)}else{const o=n.f.get(i);o!==void 0&&this.#r(o,i)}return i}case 17:{const t=n.parent1.deref();if(t===void 0)return e.rule=n.parent2!==void 0?{kind:3,engine:n.engine,parent:n.parent2}:{kind:0,engine:void 0},this.#i(e);const i=n.parent2?.deref(),o=b(t);return i!==o&&(i?.removeNotifiableChild(e),o?.addNotifiableChild(e),n.parent2=o!==void 0?new WeakRef(o):void 0,e.recomputeDepth()&&this.#t.rebuild()),o===void 0?void 0:o.newValue!==u?o.newValue:o.value!==a?o.value:s.DO_NOT_SEND}}}send(e,n){const t=e;if(t.isClosed())throw new Error("Cannot send to this sink; it is closed");switch(this.#e){case 0:{this.run(()=>this.#r(t,n));break}case 1:{this.#r(t,n);break}default:throw new Error("send() cannot be called during an FRP transaction")}}run(e){if(this.#e!==0)throw new Error("run() cannot be called during an FRP transaction");try{this.#e=1,e(),this.#e=2;const n=this.#t,t=new Set;for(;;){const i=n.poll();if(i===void 0)break;if(t.has(i))continue;t.add(i),L(i)&&(this.#e=3);const o=this.#i(i);this.#e=2,o!==s.DO_NOT_SEND&&this.#r(i,o)}for(const i of this.#n)i.value!==a&&(i.value=i.newValue);this.#e=4;for(const i of this.#n)i.rule.kind===2&&i.rule.f(i.newValue);this.#e=5}finally{this.#t.reset();for(const n of this.#n)n.newValue=u;this.#n.length=0,this.#e=0}}isBusy(){return this.#e===2||this.#e===3}sample(e){return this.#e===2&&console.error("sample() should not be called here"),e.value}cell(e){return new l(this.#s,e)}sink(e){return new l(e!==void 0?{kind:1,engine:this,parents:[],f:e}:this.#s,a)}}s.Engine=C;function q(r,e){const n=r.rule.engine;if(n===void 0)throw new Error("Cannot connect; sink is already closed");if(n.isBusy())throw new Error("Cannot connect during an FRP transaction");if(r.rule.kind!==1)throw new Error("Cannot connect; sink is already connected");e.value!==a&&n.send(r,e.value);const t=r.rule,i=new WeakRef(e);t.parents===void 0?r.rule={kind:3,engine:n,parent:i}:t.parents.push(i),e.addNotifiableChild(r),r.recomputeDepth()}function V(r,e){const n=r.rule.engine;return n===void 0&&r.value===a?s.NEVER:new l(n===void 0?g:{kind:4,engine:n,parent:new WeakRef(r),f:e},r.value!==a?e(r.value):a)}function R(r,e,n){const t=r,i=t.rule.engine;return new l(i===void 0?g:{kind:6,engine:i,parent:new WeakRef(t),f:n},e)}function T(r,e,n){const t=r,i=t.rule.engine;if(i===void 0)return[S(e),s.NEVER];const o=R(r,e,n),c=new l({kind:3,engine:i,parent:new WeakRef(o)},a);return[o,c]}function D(r,e,n,t){const i=r,o=e,c=i.rule.engine;if(c===void 0)return s.NEVER;const A=n?13:11;return new l({kind:A,engine:c,parent:new WeakRef(i),cell:o,f:t},a)}function U(r,e,n,t){if(e.length===0)return r.map(t);if(e.length===1)return D(r,e[0],n,t);const i=r,o=e,c=i.rule.engine;if(c===void 0)return s.NEVER;const A=n?14:12;return new l({kind:A,engine:c,parent:new WeakRef(i),cells:o,f:t},a)}s.NEVER=new l(g,a);function S(r){return new l(g,r)}s.constant=S,s.UNDEFINED=S(void 0);function P(r,e){const n=r;let t;for(const c of n)if(t=c.rule.engine,t!==void 0)break;if(n.length===0)return S(e());if(n.length===1)return n[0].map(e);if(n.length===2)return n[0].lift(n[1],e);const i=n.map(c=>c.value),o=e(...i);return t===void 0?S(o):new l({kind:8,engine:t,parents:n,f:e},o)}s.liftAll=P;function I(...r){const e=r.filter(t=>!t.isClosed());if(e.length===0)return s.NEVER;if(e.length===1)return e[0];const n=y(e[0]);return new l({kind:10,engine:n,parents:e.map(t=>new WeakRef(t))},a)}s.select=I;function j(r){const e=r,n=e.rule.engine;return n===void 0?e:new l({kind:15,engine:n,parent:new WeakRef(e),f:new Map},e.value)}s.branch=j;function x(r){const e=r,n=e.value,t=e.rule.engine;if(t===void 0)return n??s.UNDEFINED;const i={kind:17,engine:t,parent1:new WeakRef(e),parent2:n!==void 0?new WeakRef(n):void 0};return new l(i,n?.value)}s.flatten=x;function J(r,e,n=s.Type.STR){const t=i=>{try{window.localStorage.setItem(r,n.toStr(i))}catch(o){console.error(`Failed to store '${r}' in local storage`,o)}};try{const i=e,o=window.localStorage.getItem(r);o!==null?(i.send(n.fromStr(o)),i.listen(t)):i.observe(t)}catch{console.warn(`Failed to load '${r}' from local storage`)}}s.persist=J;function y(r){const e=r.rule.engine;if(e===void 0)throw new k("Node is closed",r);return e}function b(r){return r.newValue!==u?r.newValue:r.value}function L(r){switch(r.rule.kind){case 4:return r.value===a;case 5:case 6:case 9:case 11:case 12:return!0;default:return!1}}function p(r){if(r.isClosed())return;const e=r.rule;r.rule=g,r.depth=0,_(e,n=>n.removeNotifiableChild(r)),N(e,n=>n.removeNonNotifiableChild(r)),d(r,n=>n.tidy()),r.notifiableChildren.length=0,r.nonNotifiableChildren.length=0}function H(r){if(r.value===a)throw new k("Expected cell",r)}function Q(r,...e){for(const n of e)if(n.rule.engine!==void 0&&n.rule.engine!==r)throw new k("Object is owned by a different FRP engine",[r,n])}function G(...r){if(r.every(e=>e.newValue===u))throw new k("At least one of these nodes should have been updated",r)}function M(r){const e=new Map,n=[r];for(;;){const t=n.shift();if(t===void 0)throw new k("Expected to report cycle, but no cycle was found!",r);h(t.rule,i=>{if(i===r){const o=[];let c=t;for(;c!==void 0;)o.push(c),c=e.get(c);o.reverse();const A=`Circular dependency:
---
`+o.map($=>$.name??"<anonymous>").join(`
`);throw console.error(A,o),new Error(`${A}
---
See console for more details`)}else e.has(i)||(n.push(i),e.set(i,t))})}}class k extends Error{data;constructor(e,n){super(e),this.data=n}}})(Furple||(Furple={}));var Furple;(function(s){let g;(function(f){const O=u=>u,m=u=>`${u}`;f.BOOL={toStr:u=>u?"true":"false",fromStr:u=>u==="true"},f.INT={toStr:m,fromStr:u=>parseInt(u)},f.BIGINT={toStr:m,fromStr:BigInt},f.FLOAT={toStr:m,fromStr:parseFloat},f.STR={toStr:O,fromStr:O};function _(u){return{toStr:a=>JSON.stringify(a.map(u.toStr)),fromStr:a=>JSON.parse(a).map(u.fromStr)}}f.array=_;function N(u){return{toStr:a=>JSON.stringify(d(a,u.toStr)),fromStr:a=>d(JSON.parse(a),u.fromStr)}}f.object=N;function h(u){return{toStr:a=>JSON.stringify(d(Object.fromEntries(a),u.toStr)),fromStr:a=>new Map(Object.entries(d(JSON.parse(a),u.fromStr)))}}f.map=h;function w(u){return{toStr:a=>JSON.stringify([...a].map(u.toStr)),fromStr:a=>new Set(JSON.parse(a).map(u.fromStr))}}f.set=w;function d(u,a){const E=Object.create(null);for(const[l,v]of Object.entries(u))E[l]=a(v);return E}})(g=s.Type||(s.Type={}))})(Furple||(Furple={}));
