"use strict";var Furple;(function(s){function _(w){return s.flatten(w.map(p=>s.liftAll(p,(...h)=>h)))}s.flattenArray=_;function u(w,p){return _(w.map(h=>h.map(p)))}s.mapArray=u;function O(w,p){return s.flatten(w.map(h=>s.select(...h.map(p))))}s.selectArray=O;function N(w,p,h){return s.flatten(w.map(f=>s.liftAll(f,(...o)=>o.reduce(h,p))))}s.foldArray=N;function k(w,p,h){const f=s.constant(p);return s.flatten(w.map(o=>m(o,f,h,0,o.length)))}s.foldAssociative=k;function m(w,p,h,f,o){if(f===o)return p;if(f+1===o)return w[f];{const l=f+o>>>1,D=m(w,p,h,f,l),d=m(w,p,h,l,o);return D.lift(d,h)}}})(Furple||(Furple={}));var Furple;(function(s){const _={kind:0,engine:void 0},u=Symbol();function O(i,e){const n=i.parents;if(n!==void 0)for(let t=n.length-1;t>=0;--t){const r=n[t].deref();if(r!==void 0){if(e(r)===u)return u}else n[t]=n[n.length-1],n.pop()}}function N(i,e){const n=i.parents;for(let t=0;t<n.length;){const r=n[t].deref();if(r===void 0)n.splice(t,1);else{if(e(r)===u)return u;++t}}}function k(i,e,n){for(const t of i.parents){const r=t.deref();if(r===void 0){n?.();return}else if(e(r)===u)return u}}function m(i,e){switch(i.kind){case 0:case 19:case 20:return;case 1:return O(i,e);case 2:case 3:case 17:case 18:case 6:case 4:case 5:case 13:case 14:case 15:case 16:{const t=i.parent.deref();return t!==void 0?e(t):void 0}case 7:return e(i.parent1)===u?u:e(i.parent2);case 8:{for(const t of i.parents)if(e(t)===u)return u;return}case 12:return N(i,e);case 11:return k(i,e);case 9:case 10:case 21:{const t=i.parent1.deref(),r=i.parent2?.deref();return t!==void 0&&e(t)===u?u:r!==void 0?e(r):void 0}}const n=i}function w(i,e){switch(i.kind){case 19:case 20:{const n=i.parent.deref();n!==void 0&&e(n);return}case 15:{e(i.cell);return}case 16:{for(const n of i.cells)if(e(n)===u)return;return}}}function p(i,e){m(i,e)!==u&&w(i,e)}function h(i,e){for(const n of i.notifiableChildren)e(n)}function f(i,e){h(i,e);for(const n of i.nonNotifiableChildren)e(n);if(i.rule.kind===17||i.rule.kind===18)for(const n of i.rule.f.values())e(n)}s.DO_NOT_SEND=Symbol();const o=Symbol(),l=Symbol(),D=Object.is;class d{rule;value;name=void 0;depth=0;newValue=o;equalityFunc=D;notifiableChildren=[];nonNotifiableChildren=[];constructor(e,n){this.rule=e,this.value=n,m(e,t=>{t.addNotifiableChild(this)}),this.#n()}named(e){return this.name=e,this}#n(){const e=this.depth;let n=0;return p(this.rule,t=>{t.depth>=n&&(n=t.depth+1)}),this.depth=n,n>e}recomputeDepth(){if(!this.#n())return!1;const e=[this];for(;e.length>0;){const n=e.pop();f(n,t=>{t===this&&z(this),t.#n()&&e.push(t)})}return!0}addNotifiableChild(e){this.notifiableChildren.push(e)}addNonNotifiableDependent(e){this.nonNotifiableChildren.push(e)}removeNotifiableChild(e){const n=this.notifiableChildren,t=n.indexOf(e);t>=0&&n.splice(t,1)}removeNonNotifiableChild(e){if(e.rule.kind===19||e.rule.kind===20)this.rule.f.delete(e.rule.key);else{const n=this.nonNotifiableChildren,t=n.indexOf(e);t>=0&&n.splice(t,1)}}isClosed(){return this.rule.kind===0}close(){if(this.rule.engine?.isBusy())throw new Error("close() cannot be called during an FRP transaction");return g(this),this}tidy(){const e=this.rule;let n=!0;if(m(e,t=>{if(!t.isClosed())return n=!1,u}),n){g(this);return}switch(e.kind){case 9:{const t=e.parent1.deref(),r=e.parent2.deref();t===void 0||t.isClosed()?this.rule={kind:3,engine:e.engine,parent:e.parent2}:(r===void 0||r.isClosed())&&(this.rule={kind:3,engine:e.engine,parent:e.parent1});break}case 10:{const t=e.parent1.deref(),r=e.parent2.deref();(t===void 0||r===void 0||t.isClosed()||r.isClosed())&&g(this);break}case 11:{for(const t of e.parents){const r=t.deref();if(r===void 0||r.isClosed()){g(this);break}}break}case 12:{e.parents.length===1&&(this.rule={kind:3,engine:e.engine,parent:e.parents[0]});break}}}listen(e){const n=this.rule.engine;return n!==void 0?new d({kind:2,engine:n,parent:new WeakRef(this),f:e},l):this}observe(e){return e(this.value),this.listen(e)}send(e){b(this).send(this,e)}sendAnd(e,n){const t=b(this);t.run(()=>{t.send(this,e),n()})}connect(e){return q(this,e),this}sample(){const e=this.rule.engine;return e!==void 0?e.sample(this):this.value}setEqualityFunction(e){if(f(this,()=>{throw new Error("Equality function should only be set when the cell is originally created")}),this.equalityFunc!==D)throw new Error("This cell already has an equality function");return this.equalityFunc=e,this}map(e){return y(this,e)}lift(e,n){const t=this,r=e,a=t.rule.engine??r.rule.engine,c=n(t.value,r.value);return a===void 0?E(c):new d({kind:7,engine:a,parent1:t,parent2:r,f:n},c)}hold(e){const n=this.rule.engine;return n===void 0?E(e):new d({kind:3,engine:n,parent:new WeakRef(this)},e)}fold(e,n){return R(this,e,n)}foldS(e,n){return T(this,e,n)[1]}foldBoth(e,n){return T(this,e,n)}filter(e){const n=this.rule.engine,t=this;return n!==void 0?new d({kind:5,engine:n,parent:new WeakRef(t),f:e},l):s.NEVER}gate(e){return this.filter(()=>e.sample())}gateLive(e){return this.snapLive(e,(n,t)=>t?n:s.DO_NOT_SEND)}merge(e,n){const t=this,r=e;if(t.isClosed())return e;if(r.isClosed())return t;const a=b(t);return new d({kind:9,engine:a,parent1:new WeakRef(t),parent2:new WeakRef(r),f:n},l)}orElse(e){return W(this,e)}mergeMutex(e){return this.merge(e,()=>{throw new Error("Mutually exclusive streams fired simultaneously")})}meet(e,n){const t=this,r=e;if(t.isClosed()||r.isClosed())return s.NEVER;const a=b(t);return new d({kind:10,engine:a,parent1:new WeakRef(t),parent2:new WeakRef(r),f:n},l)}snapshot(e,n){return A(this,e,!1,n)}snapLive(e,n){return A(this,e,!0,n)}as(e){return A(this,e,!1,(n,t)=>t)}asLive(e){return A(this,e,!0,(n,t)=>t)}asConstant(e){return y(this,()=>e)}snapshotAll(e,n){return U(this,e,!1,n)}snapAllLive(e,n){return U(this,e,!0,n)}when(e){const n=this.rule;switch(n.kind){case 0:return this.value!==l?E(this.value===e):s.NEVER;case 17:{const t=this;let r=n.f.get(e);return r===void 0&&(r=new d({kind:19,engine:n.engine,parent:new WeakRef(t),key:e},this.value===e),n.f.set(e,r)),r}case 18:{const t=this;let r=n.f.get(e);return r===void 0&&(r=new d({kind:20,engine:n.engine,parent:new WeakRef(t),key:e},l),n.f.set(e,r)),r}}throw new S("Cannot branch on non-BRANCH node",this)}}const I=[d,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,BigUint64Array,Int8Array,Int16Array,Int32Array,BigInt64Array,Float32Array,Float64Array];function Q(i){return I.some(e=>i instanceof e)?i:Object.freeze(i)}class P{#n=[];#t=0;#e=0;enqueue(e){const n=this.#n,t=e.depth;for(;n.length<=t;)n.push([]);n[t].push(e),++this.#t}poll(){const e=this.#n;let n=this.#e;for(;n<e.length;){if(e[n].length>0)return--this.#t,e[n].pop();++this.#e,++n}}rebuild(){const e=this.#n.flat();this.reset();for(const n of e)this.enqueue(n)}reset(){for(const e of this.#n)e.length=0;this.#t=0,this.#e=0}}function B(){return new v}s.engine=B;class v{#n=[];#t=new P;#e=0;#s={kind:1,engine:this,parents:void 0,f:void 0};#r(e,n){if(e.value!==l&&e.equalityFunc(e.value,n))return;const t=e.rule;if(t.kind===1&&e.newValue!==o){const r=t.f;if(r===void 0)throw new S("This sink cannot coalesce simultaneous events",e);e.newValue=r(e.newValue,n);return}e.newValue=n,this.#n.push(e),h(e,r=>this.#t.enqueue(r))}#i(e){const n=e.rule;switch(n.kind){case 0:case 19:case 20:throw new S("This node should not be recomputed",e);case 1:{if(n.parents===void 0)return e.newValue;const t=n.f;let r=o;return O(n,a=>{r===o?r=a.newValue:a.newValue!==o&&(r=t(r,a.newValue))}),r!==o?r:s.DO_NOT_SEND}case 2:case 3:{const t=n.parent.deref();return t===void 0?(g(e),s.DO_NOT_SEND):t.newValue}case 4:{const t=n.parent.deref();return t===void 0?(g(e),s.DO_NOT_SEND):n.f(t.newValue)}case 5:{const t=n.parent.deref();if(t===void 0)return g(e),s.DO_NOT_SEND;const r=t.newValue;return n.f(r)?r:s.DO_NOT_SEND}case 6:{const t=n.parent.deref();return t===void 0?(g(e),s.DO_NOT_SEND):n.f(e.value,t.newValue)}case 7:return n.f(V(n.parent1),V(n.parent2));case 8:{const t=n.parents.map(V);return n.f(...t)}case 9:{const t=n.parent1.deref(),r=n.parent2.deref();return t===void 0?r===void 0?(g(e),s.DO_NOT_SEND):(e.rule={kind:3,engine:n.engine,parent:n.parent2},this.#i(e)):r===void 0?(e.rule={kind:3,engine:n.engine,parent:n.parent1},this.#i(e)):r.newValue===o?t.newValue:t.newValue===o?r.newValue:n.f(t.newValue,r.newValue)}case 10:{const t=n.parent1.deref(),r=n.parent2.deref();return t===void 0||r===void 0?(g(e),s.DO_NOT_SEND):t.newValue!==o&&r.newValue!==o?n.f(t.newValue,r.newValue):s.DO_NOT_SEND}case 11:{const t=[];return k(n,r=>{if(r.newValue===o)return u;t.push(r.newValue)},()=>{g(e)}),t.length===n.parents.length?n.f(...t):s.DO_NOT_SEND}case 12:{let t=s.DO_NOT_SEND;return N(n,r=>{if(r.newValue!==o)return t=r.newValue,u}),t}case 13:{const t=n.parent.deref();return t===void 0?(g(e),s.DO_NOT_SEND):n.f(t.newValue,n.cell.value)}case 14:{const t=n.parent.deref();if(t===void 0)return g(e),s.DO_NOT_SEND;const r=n.cells.map(a=>a.value);return n.f(t.newValue,...r)}case 15:{const t=n.parent.deref();return t===void 0?(g(e),s.DO_NOT_SEND):n.f(t.newValue,V(n.cell))}case 16:{const t=n.parent.deref();if(t===void 0)return g(e),s.DO_NOT_SEND;const r=n.cells.map(V);return n.f(t.newValue,...r)}case 17:{const t=n.parent.deref();if(t===void 0)return g(e),s.DO_NOT_SEND;const r=t.newValue,a=n.f.get(t.value),c=n.f.get(r);return a!==void 0&&this.#r(a,!1),c!==void 0&&this.#r(c,!0),r}case 18:{const t=n.parent.deref();if(t===void 0)return g(e),s.DO_NOT_SEND;const r=t.newValue,a=n.f.get(r);return a!==void 0&&this.#r(a,r),r}case 21:{const t=n.parent1.deref();if(t===void 0)return e.rule=n.parent2!==void 0?{kind:3,engine:n.engine,parent:n.parent2}:{kind:0,engine:void 0},this.#i(e);const r=n.parent2?.deref(),a=V(t);return r!==a&&(r?.removeNotifiableChild(e),a?.addNotifiableChild(e),n.parent2=a!==void 0?new WeakRef(a):void 0,e.recomputeDepth()&&this.#t.rebuild()),a===void 0?void 0:a.newValue!==o?a.newValue:a.value!==l?a.value:s.DO_NOT_SEND}}}send(e,n){const t=e;if(t.isClosed())throw new Error("Cannot send to this sink; it is closed");switch(this.#e){case 0:{this.run(()=>this.#r(t,n));break}case 1:{this.#r(t,n);break}default:throw new Error("send() cannot be called during an FRP transaction")}}run(e){if(this.#e!==0)throw new Error("run() cannot be called during an FRP transaction");try{this.#e=1,e(),this.#e=2;const n=this.#t,t=new Set;for(;;){const r=n.poll();if(r===void 0)break;if(t.has(r))continue;t.add(r),$(r)&&(this.#e=3);const a=this.#i(r);this.#e=2,a!==s.DO_NOT_SEND&&this.#r(r,a)}for(const r of this.#n)r.value!==l&&(r.value=r.newValue);this.#e=4;for(const r of this.#n)r.rule.kind===2&&r.rule.f(r.newValue);this.#e=5}finally{this.#t.reset();for(const n of this.#n)n.newValue=o;this.#n.length=0,this.#e=0}}isBusy(){return this.#e===2||this.#e===3}sample(e){return this.#e===2&&console.error("sample() should not be called here"),e.value}cell(e){return new d(this.#s,e)}sink(e){return new d(e!==void 0?{kind:1,engine:this,parents:[],f:e}:this.#s,l)}}s.Engine=v;function q(i,e){const n=i.rule.engine;if(n===void 0)throw new Error("Cannot connect; sink is already closed");if(n.isBusy())throw new Error("Cannot connect during an FRP transaction");if(i.rule.kind!==1)throw new Error("Cannot connect; sink is already connected");e.value!==l&&n.send(i,e.value);const t=i.rule,r=new WeakRef(e);t.parents===void 0?i.rule={kind:3,engine:n,parent:r}:t.parents.push(r),e.addNotifiableChild(i),i.recomputeDepth()}function y(i,e){const n=i.rule.engine;return n===void 0&&i.value===l?s.NEVER:new d(n===void 0?_:{kind:4,engine:n,parent:new WeakRef(i),f:e},i.value!==l?e(i.value):l)}function R(i,e,n){const t=i,r=t.rule.engine;return new d(r===void 0?_:{kind:6,engine:r,parent:new WeakRef(t),f:n},e)}function T(i,e,n){const t=i,r=t.rule.engine;if(r===void 0)return[E(e),s.NEVER];const a=R(i,e,n),c=new d({kind:3,engine:r,parent:new WeakRef(a)},l);return[a,c]}function A(i,e,n,t){const r=i,a=e,c=r.rule.engine;if(c===void 0)return s.NEVER;const C=n?15:13;return new d({kind:C,engine:c,parent:new WeakRef(r),cell:a,f:t},l)}function U(i,e,n,t){if(e.length===0)return i.map(t);if(e.length===1)return A(i,e[0],n,t);const r=i,a=e,c=r.rule.engine;if(c===void 0)return s.NEVER;const C=n?16:14;return new d({kind:C,engine:c,parent:new WeakRef(r),cells:a,f:t},l)}s.NEVER=new d(_,l);function E(i){return new d(_,i)}s.constant=E,s.UNDEFINED=E(void 0);function j(i,e){const n=i;let t;for(const c of n)if(t=c.rule.engine,t!==void 0)break;if(n.length===0)return E(e());if(n.length===1)return n[0].map(e);if(n.length===2)return n[0].lift(n[1],e);const r=n.map(c=>c.value),a=e(...r);return t===void 0?E(a):new d({kind:8,engine:t,parents:n,f:e},a)}s.liftAll=j;function x(i,e){const n=[];for(const r of i){const a=r;if(a.isClosed())return s.NEVER;n.push(new WeakRef(a))}const t=b(i[0]);return new d({kind:11,engine:t,parents:n,f:e},l)}s.meetAll=x;function W(...i){const e=i.filter(t=>!t.isClosed());if(e.length===0)return s.NEVER;if(e.length===1)return e[0];const n=b(e[0]);return new d({kind:12,engine:n,parents:e.map(t=>new WeakRef(t))},l)}s.select=W;function L(i){const e=i,n=e.rule.engine;if(n===void 0)return e;const t=e.value!==l?17:18;return new d({kind:t,engine:n,parent:new WeakRef(e),f:new Map},e.value)}s.branch=L;function J(i){const e=i,n=e.value,t=e.rule.engine;if(t===void 0)return n??s.UNDEFINED;const r={kind:21,engine:t,parent1:new WeakRef(e),parent2:n!==void 0?new WeakRef(n):void 0};return new d(r,n?.value)}s.flatten=J;function M(i,e,n=s.Type.STR){const t=r=>{try{window.localStorage.setItem(i,n.toStr(r))}catch(a){console.error(`Failed to store '${i}' in local storage`,a)}};try{const r=e,a=window.localStorage.getItem(i);a!==null?(r.send(n.fromStr(a)),r.listen(t)):r.observe(t)}catch{console.warn(`Failed to load '${i}' from local storage`)}}s.persist=M;function b(i){const e=i.rule.engine;if(e===void 0)throw new S("Node is closed",i);return e}function V(i){return i.newValue!==o?i.newValue:i.value}function $(i){switch(i.rule.kind){case 4:return i.value===l;case 5:case 6:case 9:case 13:case 14:return!0;default:return!1}}function g(i){if(i.isClosed())return;const e=i.rule;i.rule=_,i.depth=0,m(e,n=>n.removeNotifiableChild(i)),w(e,n=>n.removeNonNotifiableChild(i)),f(i,n=>n.tidy()),i.notifiableChildren.length=0,i.nonNotifiableChildren.length=0}function G(i){if(i.value===l)throw new S("Expected cell",i)}function K(i,...e){for(const n of e)if(n.rule.engine!==void 0&&n.rule.engine!==i)throw new S("Object is owned by a different FRP engine",[i,n])}function Y(...i){if(i.every(e=>e.newValue===o))throw new S("At least one of these nodes should have been updated",i)}function z(i){const e=new Map,n=[i];for(;;){const t=n.shift();if(t===void 0)throw new S("Expected to report cycle, but no cycle was found!",i);p(t.rule,r=>{if(r===i){const a=[];let c=t;for(;c!==void 0;)a.push(c),c=e.get(c);a.reverse();const C=`Circular dependency:
---
`+a.map(H=>H.name??"<anonymous>").join(`
`);throw console.error(C,a),new Error(`${C}
---
See console for more details`)}else e.has(r)||(n.push(r),e.set(r,t))})}}class S extends Error{data;constructor(e,n){super(e),this.data=n}}})(Furple||(Furple={}));var Furple;(function(s){let _;(function(u){const O=f=>f,N=f=>`${f}`;u.BOOL={toStr:f=>f?"true":"false",fromStr:f=>f==="true"},u.INT={toStr:N,fromStr:f=>parseInt(f)},u.BIGINT={toStr:N,fromStr:BigInt},u.FLOAT={toStr:N,fromStr:parseFloat},u.STR={toStr:O,fromStr:O};function k(f){return{toStr:o=>JSON.stringify(o.map(f.toStr)),fromStr:o=>JSON.parse(o).map(f.fromStr)}}u.array=k;function m(f){return{toStr:o=>JSON.stringify(h(o,f.toStr)),fromStr:o=>h(JSON.parse(o),f.fromStr)}}u.object=m;function w(f){return{toStr:o=>JSON.stringify(h(Object.fromEntries(o),f.toStr)),fromStr:o=>new Map(Object.entries(h(JSON.parse(o),f.fromStr)))}}u.map=w;function p(f){return{toStr:o=>JSON.stringify([...o].map(f.toStr)),fromStr:o=>new Set(JSON.parse(o).map(f.fromStr))}}u.set=p;function h(f,o){const l=Object.create(null);for(const[D,d]of Object.entries(f))l[D]=o(d);return l}})(_=s.Type||(s.Type={}))})(Furple||(Furple={}));
